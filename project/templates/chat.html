<!-- <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ChatSQL: Natural Language to SQL</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    body { padding: 2rem; }
    .chat-box { height: 60vh; overflow-y: auto; border: 1px solid #ddd; padding: 1rem; background: #f9f9f9; }
    .chat-bubble.user { background: #e6f7ff; text-align: right; }
    .chat-bubble.bot { background: #e2ffe8; text-align: left; }
    .chat-bubble { border-radius: 8px; padding: 0.5rem 1rem; margin: 0.5rem 0; display: inline-block; max-width: 80%; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Conversational SQL Assistant üí¨</h2>
    <div class="chat-box" id="chat-box">
      {% if history %}
        {% for entry in history %}
          <div class="chat-bubble user"><strong>You:</strong> {{ entry['user'] }}</div>
          <div class="chat-bubble bot"><strong>Bot:</strong> {{ entry['bot'] }}</div>
        {% endfor %}
      {% endif %}
    </div>
    <form method="POST" action="/">
      <div class="input-group mt-3">
        <input type="text" name="question" class="form-control" placeholder="Ask your question..." required autofocus>
        <button class="btn btn-primary" type="submit">Send</button>
      </div>
    </form>
  </div>
</body>
</html> -->
<!-- <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Conversational SQL Chatbot</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f2f5;
            display: flex;
            flex-direction: column;
            height: 100vh;
            margin: 0;
        }
        #chat-container {
            flex: 1;
            padding: 20px;
            overflow-y: scroll;
            background-color: white;
            display: flex;
            flex-direction: column;
        }
        .message {
            max-width: 80%;
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 20px;
            line-height: 1.5;
            word-wrap: break-word;
        }
        .user {
            align-self: flex-end;
            background-color: #007bff;
            color: white;
        }
        .bot {
            align-self: flex-start;
            background-color: #e5e5ea;
            color: black;
        }
        #input-container {
            display: flex;
            padding: 10px;
            background-color: #f0f2f5;
        }
        #question-input {
            flex: 1;
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 20px;
            margin-right: 10px;
        }
        #send-button {
            padding: 10px 20px;
            background-color: #007bff;
            border: none;
            color: white;
            border-radius: 20px;
            font-size: 16px;
            cursor: pointer;
        }
        img {
            max-width: 300px;
            margin-top: 10px;
            border-radius: 10px;
        }
        table {
            border-collapse: collapse;
            width: 90%;
            margin-top: 10px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            font-size: 14px;
        }
        th {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>

<div id="chat-container">

</div>

<form id="input-container" method="post" action="/" enctype="multipart/form-data">
    <input type="text" id="question-input" name="question" placeholder="Ask a question..." required>
    <button type="submit" id="send-button">Send</button>
</form>

<script>
    const chatContainer = document.getElementById('chat-container');
    const inputForm = document.getElementById('input-container');
    const questionInput = document.getElementById('question-input');
    
    inputForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const question = questionInput.value.trim();
        if (!question) return;
    
        addMessage(question, 'user'); // User bubble
    
        const formData = new FormData();
        formData.append('question', question);
    
        const response = await fetch('/', {
            method: 'POST',
            body: formData
        });
    
        const data = await response.json();
    
        // Add each part in different bubbles:
        addMessage(`<b>Answer:</b><br>${data.answer}`, 'bot');
    
        addMessage(`<b>SQL Query:</b><pre style="white-space: pre-wrap; word-wrap: break-word;">${data.sql_query}</pre>`, 'bot');
    
        if (data.data.length > 0) {
            let tableHTML = "<b>Result Preview:</b><br><table><thead><tr>";
            const columns = Object.keys(data.data[0]);
            columns.forEach(col => tableHTML += `<th>${col}</th>`);
            tableHTML += "</tr></thead><tbody>";
    
            data.data.forEach(row => {
                tableHTML += "<tr>";
                columns.forEach(col => tableHTML += `<td>${row[col]}</td>`);
                tableHTML += "</tr>";
            });
            tableHTML += "</tbody></table>";
    
            addMessage(tableHTML, 'bot');
        }
    
        if (data.visualization) {
            addMessage(`<b>Visualization:</b><br><img src="/static/images/${data.visualization}" style="max-width: 100%; height: auto; border-radius: 10px;">`, 'bot');
        }
    
        questionInput.value = '';
        chatContainer.scrollTop = chatContainer.scrollHeight;
    });
    
    function addMessage(text, sender) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender}`;
        messageDiv.innerHTML = text;
        chatContainer.appendChild(messageDiv);
    }
    </script>
    

</body>
</html> -->
<!-- <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Conversational SQL Chatbot</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding-top: 60px; /* Because of fixed navbar */
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden; /* Don't let body scroll */
        }
        #navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background-color: #007bff;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px 0;
        }
        #navbar a {
            color: white;
            text-decoration: none;
            margin: 0 20px;
            font-size: 18px;
        }
        #navbar a:hover {
            text-decoration: underline;
        }
        #main-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        #chat-container {
            flex: 2;
            padding: 20px;
            overflow-y: auto;
            background-color: white;
        }
        #input-container {
            display: flex;
            padding: 10px;
            background-color: #f0f2f5;
        }
        #question-input {
            flex: 1;
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 20px;
            margin-right: 10px;
        }
        #send-button {
            padding: 10px 20px;
            background-color: #007bff;
            border: none;
            color: white;
            border-radius: 20px;
            font-size: 16px;
            cursor: pointer;
        }
        .message {
            max-width: 80%;
            margin-bottom: 15px;
            padding: 12px 16px;
            border-radius: 20px;
            line-height: 1.5;
            word-wrap: break-word;
        }
        .user {
            align-self: flex-end;
            background-color: #007bff;
            color: white;
        }
        .bot {
            align-self: flex-start;
            background-color: #e5e5ea;
            color: black;
        }
        #live-dashboard-header {
            padding: 10px;
            background-color: #eeeeee;
            text-align: center;
            font-weight: bold;
        }
        #dashboard-container {
            flex: 1;
            overflow-y: auto;
            background-color: #fafafa;
            padding: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
        }
        table {
            border-collapse: collapse;
            width: 90%;
            margin-top: 10px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            font-size: 14px;
        }
        th {
            background-color: #f2f2f2;
        }
        img {
            max-width: 300px;
            height: auto;
            border-radius: 10px;
            cursor: pointer;
        }
    </style>
</head>
<body>

<div id="navbar">
    <a href="/">üó®Ô∏è Chat</a>
    <a href="/dashboard">üìä Dashboard</a>
</div>

<div id="main-container">
    <div id="chat-container">
    </div>

    <form id="input-container" method="post" action="/" enctype="multipart/form-data">
        <input type="text" id="question-input" name="question" placeholder="Ask a question..." required>
        <button type="submit" id="send-button">Send</button>
    </form>

    <div id="live-dashboard-header">üì• My Live Dashboard</div>
    <div id="dashboard-container">

    </div>
</div>

<script>
const chatContainer = document.getElementById('chat-container');
const inputForm = document.getElementById('input-container');
const questionInput = document.getElementById('question-input');

inputForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const question = questionInput.value.trim();
    if (!question) return;

    addMessage(question, 'user');

    const formData = new FormData();
    formData.append('question', question);

    const response = await fetch('/', {
        method: 'POST',
        body: formData
    });

    const data = await response.json();

    addMessage(`<b>Answer:</b><br>${data.answer}`, 'bot');

    addMessage(`<b>SQL Query:</b><pre style="white-space: pre-wrap; word-wrap: break-word;">${data.sql_query}</pre>`, 'bot');

    if (data.data.length > 0) {
        let tableHTML = "<b>Result Preview:</b><br><table><thead><tr>";
        const columns = Object.keys(data.data[0]);
        columns.forEach(col => tableHTML += `<th>${col}</th>`);
        tableHTML += "</tr></thead><tbody>";

        data.data.forEach(row => {
            tableHTML += "<tr>";
            columns.forEach(col => tableHTML += `<td>${row[col]}</td>`);
            tableHTML += "</tr>";
        });
        tableHTML += "</tbody></table>";
        addMessage(tableHTML, 'bot');
    }

    if (data.visualization) {
        const vizHTML = `
            <b>Visualization:</b><br>
            <img 
                src="/static/images/${data.visualization}" 
                onclick="addToDashboard('/static/images/${data.visualization}')"
            >
        `;
        addMessage(vizHTML, 'bot');
    }

    questionInput.value = '';
    chatContainer.scrollTop = chatContainer.scrollHeight;
});

function addMessage(text, sender) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}`;
    messageDiv.innerHTML = text;
    chatContainer.appendChild(messageDiv);
}

function addToDashboard(imageSrc) {
    let images = JSON.parse(localStorage.getItem('dashboard_images')) || [];
    if (!images.includes(imageSrc)) {
        images.push(imageSrc);
        localStorage.setItem('dashboard_images', JSON.stringify(images));
    }

    const dashboard = document.getElementById('dashboard-container');
    const img = document.createElement('img');
    img.src = imageSrc;
    dashboard.appendChild(img);
}
</script> -->

<!-- <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Conversational SQL Chatbot</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f0f2f5;
      margin: 0;
      padding-top: 60px;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    #navbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background-color: #007bff;
      color: white;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 10px;
      z-index: 1000;
    }
    #navbar a {
      color: white;
      text-decoration: none;
      margin: 0 20px;
      font-size: 18px;
    }
    #navbar a:hover {
      text-decoration: underline;
    }

    #main-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      height: 100%;
      overflow: hidden;
    }

    #chat-container {
      flex-grow: 1;
      padding: 20px;
      overflow-y: auto;
      background-color: white;
    }

    #splitter {
      height: 5px;
      background: #ccc;
      cursor: row-resize;
    }

    #dashboard-section {
      display: flex;
      flex-direction: column;
      height: 30%;
      min-height: 100px;
      background-color: #fafafa;
      overflow: hidden;
    }

    #live-dashboard-header {
      text-align: center;
      padding: 10px;
      background-color: #eeeeee;
      font-weight: bold;
    }

    #dashboard-container {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
    }

    #input-container {
      display: flex;
      padding: 10px;
      background-color: #f0f2f5;
    }
    #question-input {
      flex: 1;
      padding: 10px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 20px;
      margin-right: 10px;
    }
    #send-button {
      padding: 10px 20px;
      background-color: #007bff;
      border: none;
      color: white;
      border-radius: 20px;
      font-size: 16px;
      cursor: pointer;
    }
    .message {
      max-width: 80%;
      margin-bottom: 15px;
      padding: 12px 16px;
      border-radius: 20px;
      line-height: 1.5;
      word-wrap: break-word;
    }
    .user {
      align-self: flex-end;
      background-color: #007bff;
      color: white;
    }
    .bot {
      align-self: flex-start;
      background-color: #e5e5ea;
      color: black;
    }
    img {
  width: 80%;
  max-width: 800px;
  height: auto;
  border-radius: 10px;
  cursor: pointer;
  margin-bottom: 10px;
}

    table {
      border-collapse: collapse;
      width: 90%;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      font-size: 14px;
    }
    th {
      background-color: #f2f2f2;
    }
  </style>
</head>
<body>

<div id="navbar">
  <a href="/">üó®Ô∏è Chat</a>
  <a href="/dashboard">üìä Dashboard</a>
</div>

<div id="main-container">
  <div id="chat-container">
  </div>

  <form id="input-container" method="post" action="/" enctype="multipart/form-data">
    <input type="text" id="question-input" name="question" placeholder="Ask a question..." required>
    <button type="submit" id="send-button">Send</button>
  </form>

  <div id="splitter"></div>

  <div id="dashboard-section">
    <div id="live-dashboard-header">üì• My Live Dashboard</div>
    <div id="dashboard-container">
    </div>
  </div>
</div>

<script>
// Dragging to resize splitter
const splitter = document.getElementById('splitter');
const chatContainer = document.getElementById('chat-container');
const dashboardSection = document.getElementById('dashboard-section');

let isDragging = false;

splitter.addEventListener('mousedown', function(e) {
  isDragging = true;
  document.body.style.cursor = 'row-resize';
});

document.addEventListener('mouseup', function(e) {
  isDragging = false;
  document.body.style.cursor = 'default';
});

document.addEventListener('mousemove', function(e) {
  if (!isDragging) return;
  const containerTop = document.getElementById('main-container').getBoundingClientRect().top;
  const newHeight = e.clientY - containerTop - splitter.offsetHeight / 2;
  chatContainer.style.flexBasis = `${newHeight}px`;
  chatContainer.style.flexGrow = '0';
});

const inputForm = document.getElementById('input-container');
const questionInput = document.getElementById('question-input');

inputForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  const question = questionInput.value.trim();
  if (!question) return;

  addMessage(question, 'user');

  const formData = new FormData();
  formData.append('question', question);

  const response = await fetch('/', {
    method: 'POST',
    body: formData
  });

  const data = await response.json();

  addMessage(`<b>Answer:</b><br>${data.answer}`, 'bot');

  addMessage(`<b>SQL Query:</b><pre style="white-space: pre-wrap; word-wrap: break-word;">${data.sql_query}</pre>`, 'bot');

  if (data.data.length > 0) {
    let tableHTML = "<b>Result Preview:</b><br><table><thead><tr>";
    const columns = Object.keys(data.data[0]);
    columns.forEach(col => tableHTML += `<th>${col}</th>`);
    tableHTML += "</tr></thead><tbody>";

    data.data.forEach(row => {
      tableHTML += "<tr>";
      columns.forEach(col => tableHTML += `<td>${row[col]}</td>`);
      tableHTML += "</tr>";
    });
    tableHTML += "</tbody></table>";
    addMessage(tableHTML, 'bot');
  }

  if (data.visualization) {
    const vizHTML = `
      <b>Visualization:</b><br>
      <img src="/static/images/${data.visualization}" onclick="addToDashboard('/static/images/${data.visualization}')">
    `;
    addMessage(vizHTML, 'bot');
  }

  questionInput.value = '';
  chatContainer.scrollTop = chatContainer.scrollHeight;
});

function addMessage(text, sender) {
  const messageDiv = document.createElement('div');
  messageDiv.className = `message ${sender}`;
  messageDiv.innerHTML = text;
  chatContainer.appendChild(messageDiv);
}

function addToDashboard(imageSrc) {
  let images = JSON.parse(localStorage.getItem('dashboard_images')) || [];
  if (!images.includes(imageSrc)) {
    images.push(imageSrc);
    localStorage.setItem('dashboard_images', JSON.stringify(images));
  }

  const dashboard = document.getElementById('dashboard-container');
  const img = document.createElement('img');
  img.src = imageSrc;
  dashboard.appendChild(img);
}

const dashboardContainer = document.getElementById('dashboard-container');
const dashboardSec = document.getElementById('dashboard-section');

let lastScrollTop = 0;

dashboardContainer.addEventListener('scroll', function() {
    const currentScrollTop = dashboardContainer.scrollTop;

    if (currentScrollTop < lastScrollTop) {
        // User is scrolling UP
        expandDashboard();
    }

    lastScrollTop = currentScrollTop;
});

function expandDashboard() {
    const maxHeight = window.innerHeight * 0.8; // Max 80% of screen
    const currentHeight = dashboardSec.offsetHeight;
    const newHeight = currentHeight + 20; // Increase by 20px when scrolling up

    if (newHeight < maxHeight) {
        dashboardSec.style.height = `${newHeight}px`;
    }
}

</script>

</body>
</html>


</body>
</html> -->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Modern Chatbot + Dashboard Aesthetic</title>

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary-color: #4F46E5;
      --background: #f0f2f5;
      --chat-bg: #ffffff;
      --dashboard-bg: #f8fafc;
      --bubble-user: linear-gradient(135deg, #6366F1, #8B5CF6);
      --bubble-bot: #f1f5f9;
      --text-color: #000;
      --pre-bg: #f9fafb;
    }
    [data-theme="dark"] {
      --primary-color: #6366F1;
      --background: #1f2937;
      --chat-bg: #374151;
      --dashboard-bg: #111827;
      --bubble-user: linear-gradient(135deg, #818CF8, #A78BFA);
      --bubble-bot: #4B5563;
      --text-color: #f9fafb;
      --pre-bg: #374151;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      font-family: 'Poppins', sans-serif;
      background-color: var(--background);
      color: var(--text-color);
      transition: background 0.3s, color 0.3s;
    }
    #navbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 60px;
      background-color: var(--primary-color);
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 20px;
      z-index: 100;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
    #navbar a {
      color: white;
      text-decoration: none;
      margin: 0 10px;
      font-size: 18px;
      font-weight: 600;
      transition: opacity 0.2s;
    }
    #navbar a:hover {
      opacity: 0.8;
    }
    #toggle-theme, #clear-dashboard {
      background: transparent;
      border: 1px solid white;
      color: white;
      border-radius: 20px;
      padding: 5px 15px;
      margin-left: 10px;
      cursor: pointer;
      font-size: 14px;
      transition: 0.2s;
    }
    #toggle-theme:hover, #clear-dashboard:hover {
      background: white;
      color: var(--primary-color);
    }
    #main-container {
      display: flex;
      height: calc(100% - 60px);
      margin-top: 60px;
    }
    #dashboard-background {
      width: 60%;
      background-color: var(--dashboard-bg);
      overflow-y: auto;
      padding: 30px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 30px;
      transition: background 0.3s;
    }
    #chat-panel {
      width: 40%;
      background: var(--chat-bg);
      display: flex;
      flex-direction: column;
      border-left: 1px solid #e0e0e0;
      box-shadow: -2px 0 6px rgba(0,0,0,0.05);
      transition: background 0.3s;
    }
    #chat-container {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    #input-container {
      display: flex;
      padding: 15px;
      background: var(--chat-bg);
      border-top: 1px solid #e0e0e0;
    }
    #question-input {
      flex: 1;
      padding: 12px 18px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 30px;
      margin-right: 10px;
      outline: none;
      transition: 0.2s;
    }
    #question-input:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 5px var(--primary-color);
    }
    #send-button {
      padding: 10px 20px;
      background-color: var(--primary-color);
      border: none;
      color: white;
      border-radius: 30px;
      font-size: 16px;
      cursor: pointer;
      transition: 0.2s;
    }
    #send-button:hover {
      background-color: #4338ca;
    }
    .message {
      max-width: 80%;
      word-wrap: break-word;
      white-space: pre-wrap;
      padding: 14px 18px;
      border-radius: 18px 18px 4px 18px;
      line-height: 1.6;
      overflow-wrap: anywhere;
      font-size: 15px;
      animation: fadeIn 0.4s ease;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    .user {
      align-self: flex-end;
      background: var(--bubble-user);
      color: white;
      border-radius: 18px 18px 18px 4px; /* User asymmetric */
    }
    .bot {
      align-self: flex-start;
      background: var(--bubble-bot);
      color: var(--text-color);
    }
    img {
      width: 80%;
      max-width: 800px;
      height: auto;
      border-radius: 10px;
      margin-top: 10px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    pre {
      white-space: pre-wrap;
      word-break: break-word;
      overflow-wrap: break-word;
      background: var(--pre-bg);
      color: var(--text-color);
      padding: 10px 15px;
      border-radius: 10px;
      font-family: 'Courier New', Courier, monospace;
      font-size: 14px;
      margin-top: 5px;
      transition: background 0.3s, color 0.3s;
    }
    .keyword {
      color: #F59E0B;
      font-weight: bold;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px);}
      to { opacity: 1; transform: translateY(0);}
    }
  </style>
</head>

<div id="lightbox" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.8); z-index:200; justify-content:center; align-items:center;">
  <img id="lightbox-img" src="" style="max-width:90%; max-height:90%; border-radius:10px;">
</div>

<body>

<div id="navbar">
  <div>
    <a href="/">üó®Ô∏è Chat</a>
    <a href="/dashboard">üìä Dashboard</a>
  </div>
  <div>
    <button id="toggle-theme">üåó Dark Mode</button>
    <button id="clear-dashboard">üßπ Clear Dashboard</button>
  </div>
</div>

<div id="main-container">
  <div id="dashboard-background"></div>

  <div id="chat-panel">
    <div id="chat-container">
      <div class="message bot">
        üëã Hi! Ask me a question to start chatting!
      </div>
    </div>

    <form id="input-container" method="post" action="/" enctype="multipart/form-data">
      <input type="text" id="question-input" name="question" placeholder="Type your question..." required>
      <button type="submit" id="send-button">Send</button>
    </form>
  </div>
</div>

<script>
const chatContainer = document.getElementById('chat-container');
const dashboardBackground = document.getElementById('dashboard-background');
const inputForm = document.getElementById('input-container');
const questionInput = document.getElementById('question-input');
const toggleThemeBtn = document.getElementById('toggle-theme');
const clearDashboardBtn = document.getElementById('clear-dashboard');

inputForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  const question = questionInput.value.trim();
  if (!question) return;

  addMessage(question, 'user');

  const typingMessage = addMessage('Bot is typing...', 'bot');
  await new Promise(resolve => setTimeout(resolve, 1500)); // simulate thinking

  const formData = new FormData();
  formData.append('question', question);

  const response = await fetch('/', {
    method: 'POST',
    body: formData
  });

  const data = await response.json();
  typingMessage.remove(); // remove typing indicator

  addMessage(`<b>Answer:</b><br>${data.answer}`, 'bot');

  const highlightedSQL = highlightSQL(data.sql_query);
  addMessage(`<b>SQL Query:</b><pre>${highlightedSQL}</pre>`, 'bot');

  if (data.visualization) {
    addMessage(`<b>Visualization:</b><br><img src="/static/images/${data.visualization}" onclick="addToDashboardBackground('/static/images/${data.visualization}')">`, 'bot');
  }

  questionInput.value = '';
});

function addMessage(text, sender) {
  const messageDiv = document.createElement('div');
  messageDiv.className = `message ${sender}`;
  messageDiv.innerHTML = text;
  chatContainer.appendChild(messageDiv);
  messageDiv.scrollIntoView({ behavior: "smooth", block: "start" });
  return messageDiv;
}

function addToDashboardBackground(imageSrc) {
  const img = document.createElement('img');
  img.src = imageSrc;
  img.style.cursor = "pointer";
  img.onclick = () => openLightbox(imageSrc);
  dashboardBackground.appendChild(img);
}

const lightbox = document.getElementById('lightbox');
const lightboxImg = document.getElementById('lightbox-img');

function openLightbox(src) {
  lightboxImg.src = src;
  lightbox.style.display = "flex";
}

lightbox.addEventListener('click', () => {
  lightbox.style.display = "none";
});

function highlightSQL(sql) {
  const keywords = [
    "SELECT", "FROM", "WHERE", "GROUP BY", "ORDER BY", "HAVING", "AS", "AND", "OR", "NOT", "IN", "IS", "NULL", "JOIN", "LEFT", 
    "RIGHT", "INNER", "OUTER", "ON", "DISTINCT", "COUNT", "SUM", "AVG", "MAX", "MIN", "LIMIT", "OFFSET", "BY", "CASE", "WHEN", "THEN", "END"
  ];
  const regex = new RegExp(`\\b(${keywords.join('|')})\\b`, 'gi');
  return sql.replace(regex, match => `<span class="keyword">${match.toUpperCase()}</span>`);
}

toggleThemeBtn.addEventListener('click', () => {
  document.documentElement.toggleAttribute('data-theme');
});

clearDashboardBtn.addEventListener('click', () => {
  dashboardBackground.innerHTML = '';
});
</script>

</body>
</html>

